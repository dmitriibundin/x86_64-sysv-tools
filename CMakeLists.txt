cmake_minimum_required(VERSION 3.10)

project(stdx86 C ASM_NASM)

set(STDX_AUTOGENERATED_SRC_DIR ${CMAKE_CURRENT_BINARY_DIR}/autogenerated_src)
file(MAKE_DIRECTORY ${STDX_AUTOGENERATED_SRC_DIR})
set(STDX_ASM_NASM_BINARY_SOURCES main.S)

set(CMAKE_ASM_NASM_LINK_EXECUTABLE "ld <FLAGS> <CMAKE_ASM_NASM_LINK_FLAGS> <LINK_FLAGS> <OBJECTS>  -o <TARGET> <LINK_LIBRARIES>")

set(STDX_ASM_NASM_SOURCES min.S src/info.S)
set(STDX_ASM_NASM_FLAGS "-f elf64 -g")
#This is to workaround necessary trailing slash in the include path.
#See https://bugzilla.nasm.us/show_bug.cgi?id=3392205
set(STDX_ASM_NASM_FLAGS "${STDX_ASM_NASM_FLAGS} -I${STDX_AUTOGENERATED_SRC_DIR}/")

#convert c headers to nasm headers
set(STDX_ASM_NASM_HEADER_CONVERTER ${CMAKE_CURRENT_SOURCE_DIR}/cnasm_conv.py)
set(STDX_ASM_NASM_ERRORS_INC ${STDX_AUTOGENERATED_SRC_DIR}/errors.inc)
add_custom_command(
    OUTPUT ${STDX_ASM_NASM_ERRORS_INC} 
    COMMAND python3.7 ${STDX_ASM_NASM_HEADER_CONVERTER} ${CMAKE_CURRENT_SOURCE_DIR}/include/errors.h ${STDX_AUTOGENERATED_SRC_DIR}/errors.inc
    DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/include/errors.h
)

set(STDX_C_SOURCES main.c)
set(STDX_C_FLAGS "-Wno-unused-variable -Wextra -Werror -pedantic -Wstrict-prototypes -Wconversion -Wattributes -fno-stack-protector -g3 -O3")

set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} ${STDX_C_FLAGS}")

set_source_files_properties(${STDX_ASM_NASM_SOURCES} ${STDX_ASM_NASM_BINARY_SOURCES} PROPERTIES LANGUAGE ASM_NASM)
set(CMAKE_ASM_NASM_COMPILE_OBJECT "${CMAKE_ASM_NASM_COMPILE_OBJECT} ${STDX_ASM_NASM_FLAGS}")

include_directories("include")
message(${STDX_ASM_NASM_ERRORS_INC})
add_executable(bin ${STDX_C_SOURCES} ${STDX_ASM_NASM_ERRORS_INC} ${STDX_ASM_NASM_SOURCES})
set_target_properties(bin PROPERTIES LINKER_LANGUAGE C)

add_executable(bin_asm ${STDX_ASM_NASM_ERRORS_INC} ${STDX_ASM_NASM_BINARY_SOURCES})
set_target_properties(bin_asm PROPERTIES LINKER_LANGUAGE ASM_NASM)